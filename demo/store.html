<!DOCTYPE html>
<html lang="en">
<head>
    <title></title>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8"/>
    <style>
        #test {
            max-width: 960px;
            margin: 0 auto;
        }
    </style>
    <link href="../dist/css/default.css" rel="stylesheet"/>
</head>
<body>
<div id="test" data-ver-role="test">
    <form action="" class="form-horizontal">
        <div class="form-group row">
            <label for="" class="control-label col-xs-3">Name:</label>
            <div class="col-xs-9">
                <input type="text" class="form-control" name="name" data-bind="value: data.name">
            </div>
        </div>
        <div class="form-group row">
            <div class="col-xs-offset-3">
                <button class="btn btn-default" data-bind="events: { click: submitHandler }">Submit</button>
            </div>
        </div>
    </form>
    <div data-role="window"
         data-title="About Alvar Aalto"
         data-width="300"
         data-actions="['Minimize', 'Maximize', 'Close']"
         data-height="150"
         data-bind="visible: isVisible">
    </div>
    <script src="../node_modules/sinon/pkg/sinon.js"></script>
    <script src="../node_modules/sinon/pkg/sinon-server.js"></script>

    <script src="../bower_components/jquery/dist/jquery.js"></script>
    <script src="../bower_components/lodash/dist/lodash.js"></script>
    <script src="../bower_components/veronica/dist/veronica.js"></script>
    <script src="../dist/js/veronica-ui.js"></script>
    <script>
        var app = veronica.createApp();
        app.use(veronicaui);

        var ObservableObject = kendo.data.ObservableObject;
        var SourceObservableObject = ObservableObject.extend({
            init: function (options) {
                options || (options = {});

                options.value || (options.value = {});
                this.reset(options.value);


                if (options.dataSource) {
                    this._dataSource = options.dataSource;
                    this._bindEvents();
                }
            },
            _bindEvents: function () {
                var me = this;
                var dataSource = this._dataSource;
                dataSource.bind('change', function (e) {
                    if (!e.action) {
                        var data = dataSource.at(0).toJSON();
                        $.each(data, function (field, val) {
                            me.set(field, val);
                        });
                    }
                });
            },
            load: function (options) {
                return this._dataSource.fetch(options);
            },
            data: function (data) {
                return this._dataSource.data(data);
            },
            reset: function (value) {
                ObservableObject.fn.init.call(this, value);
                this.trigger('reset', {
                    value: value
                });
            },
            shouldSerialize: function (field) {
                var rt = ObservableObject.fn.shouldSerialize.call(this, field);
                var noSerialize = ['_dataSource'];
                return rt && noSerialize.indexOf(field) < 0;
            },
            dataSource: function () {
                return this._dataSource;
            },
            _backOptions: function (options) {
                options = $.extend(true, {
                    data: this.toJSON()
                }, options);
                return options;
            },
            create: function (options) {
                return this.dataSource().createApi(this._backOptions());
            },
            update: function (options) {
                return this.dataSource().updateApi(this._backOptions());
            },
            remove: function (options) {
                return this.dataSource().removeApi(this._backOptions());
            },

        });


        //        var fake = sinon.useFakeXMLHttpRequest();
        //        fake.onCreate = function(xhr){
        //            xhr.respond(200, {'Content-Type': 'application/json'}, JSON.stringify([{
        //                id: 1, name: "Johe Doe"
        //            }]));
        //        };
//        var server = sinon.fakeServer.create();
//        server.respondWith('GET', '/Test',
//                [200, {'Content-Type': 'application/json'}, JSON.stringify({
//                    data: {
//                        id: 1, name: "Johe Doe"
//                    }
//                })]);

        var dataSource = new kendo.data.ApiDataSource({
            schema: {
                model: {
                    id: "id"
                },
                data: function (resp) {
                    var data = resp['data'];

                    if (!Array.isArray(data)) {
                        return [data];
                    }
                    return data;
                },
//                parse: function(resp, xx, xxx){
//                    debugger;
//                }
            },
            api: {
                update: {
                    url: '/Test2'
                }
            },
//            transport: {
//                read: {
//                    dataType: 'json',
//                    url: '/Test'
//                },
//
//            }
        });

        var data = new SourceObservableObject({
            dataSource: dataSource
        });
        kendo.bind($('#test'), {
            data: data,
            submitHandler: function (e) {
                e.preventDefault();
                this.data.update();
            }
        });
        data.data([{
            id: 1, name: "Johe Doe"
        }]);
        server.respond();

        console.log(dataSource.data().toJSON());
        //        dataSource.pushUpdate({id: 1, name: "Jane Doe"});
        //        console.log(dataSource.at(0).name); // displays "Jane Doe"
        //        console.log(dataSource.at(0).dirty); // displays "false"
        //        console.log(dataSource.hasChanges()); // displays "false"

        //        var app = veronica.createApp();
        //        app.use(veronicaui);
        //        app.uiKit.setDefault('keboacy');
        //        app.formValidation.setDefault('kendo');
        //        app.viewEngine.setDefault('kendo');
        //
        //        app.backendApi.add('test', {
        //            api: {
        //                upload: '/test/test'
        //            }
        //        });
        //
        //        app.widget.register('test', {
        //            defaults: {
        //                autoAction: true,
        //                enableValidation: true
        //            },
        //            initAttr: function () {
        //                this.model({
        //                    isVisible: true
        //                })
        //            },
        //            stores: {
        //                'main': {
        //                    from: '@test',
        //                    commands: {}
        //                }
        //            }
        //        });
        //        app.parser.parse();
    </script>
</body>
</html>